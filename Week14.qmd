---
title: "Week Fourteen"
format: pdf
editor: source
editor_options: 
  chunk_output_type: console
---

## Last Week

- Class Recap

- Introduction to Correlated Data


## This Week: More Correlated Data

- Tuesday: Activity

- Thursday: Lab


## Next Week:  Fall Break

## Next-Next Week:  Classification Algorithms + Final Exam Review

- Tuesday:
  - Video Lecture
  - In Class Lab

- Thursday:
  - Final Exam Review
  - Take Home Final Assigned


------------------------------------------------------------------------

\newpage

```{r}
#| include: false
library(tidyverse)
library(knitr)
library(DescTools)
library(rstanarm)
library(lme4)
set.seed(11182025)
```


## McNemar's Test

Recall McNemar's Test where we have repeated measurements on a sampling unit.

We previously framed this in the context of asking a respondent two related policy questions to evaluate whether one would be more amenable.

Another scenario would be where multiple treatments are given to a single patient. For example, we might compare a medical treatment with a placebo.



```{r}
outcomes <- matrix(c(40, 6, 8, 46), nrow = 2,
               dimnames = list("Treatment" = c("Better", "Not Better"),
                               "Placebo" = c("Better", "Not Better")))
outcomes
mcnemar.test(outcomes)
```

_Q:_ What are the null hypothesis and alternative hypothesis in this situation? How do and outcome of the test in this situation?





\newpage


### Analyzing Rater Agreement

In a similar setting, we can assess similarities of raters (or tests).

- Cohen's Kappa Measure of Agreement

$$\kappa \frac{\sum \pi_{ii} - \sum \pi_{i+}\pi_{+i}}{1 - \sum \pi_{i+}\pi_{+i}}$$
$\kappa$ is 0 expected under independence, $\kappa$ is 1 perfect agreement.


```{r}
outcomes <- matrix(c(40, 6, 8, 46), nrow = 2,
               dimnames = list("Test 1" = c("Sick", "Not Sick"),
                               "Test 2" = c("Sick", "Not Sick")))
outcomes
CohenKappa(outcomes)
```


```{r}

statement <- data.frame(
  A=c(2,3,1,3,1,2,1,2,3,3,3,3,3,2,1,3,3,2,2,1,
      2,1,3,3,2,2,1,2,1,1,2,3,3,3,3,3,1,2,1,1),
  B=c(2,2,2,1,1,2,1,2,3,3,2,3,1,3,1,1,3,2,1,2,
      2,1,3,2,2,2,3,2,1,1,2,2,3,3,3,3,2,2,2,3),
  C=c(2,2,2,1,1,2,1,2,3,3,2,3,3,3,3,2,2,2,2,3,
      2,2,3,3,2,2,3,2,2,2,2,3,3,3,3,3,3,2,2,2),
  D=c(2,2,2,1,1,2,1,2,3,3,2,3,3,3,3,3,2,2,2,2,
      3,1,3,2,2,2,1,2,2,1,2,3,3,3,3,3,3,2,2,1)
)

KappaM(statement)
```


_Q:_ Which two raters are most in agreement?




\newpage


### Modeling Correlated Data: GLMMs

### Modeling Correlated Data:

- longitudinal studies or matched sets (case - control or family clusters)

\vfill

Recall the bike rental data, now let's assume we have counts at different bike rental stations.


\vfill

```{r}
#| echo: false
u <- rnorm(6, sd = 1.5)
u <- u - mean(u) # center
alpha <- -.5
gamma_1 <- 1
gamma_2 <- 0
gamma_3 <- -.5
gamma_4 <- 2
gamma_5 <- 1.5
gamma <- c(gamma_1, gamma_2, gamma_3, gamma_4, gamma_5)

mu <- exp(alpha + c(rep(u, each = 5) + rep(gamma, 3)))

y <- rpois(30, mu)

sim_data <- tibble(y = y, 
       group = rep(c('A', 'B', 'C', "D", "E", "F"), each = 5),
       time = rep(1:5, 6))

sim_data |>
  ggplot(aes(y =y, x= time, color = group)) +
  geom_point() +
  facet_grid(~group) +
  theme_bw() +
  theme(legend.position = 'none')

```


\vfill

How might we model this data?

\vfill

$y_{it} \sim Poisson(\mu_{it})$

$log(\mu_{it}) =  \alpha_i +  \gamma_1 +  \gamma_2+  \gamma_3+  \gamma_4 +  \gamma_5$

\newpage

#### fixed effects

$y_{it} \sim Poisson(\mu_{it})$

$log(\mu_{it}) = \alpha_i +  \gamma_1 +  \gamma_2+  \gamma_3+  \gamma_4 +  \gamma_5$

Maybe if there are a few stations in the dataset, we use a categorical variable in the modeling framework. In general there may be specific interest in those stations. 


\vfill



\newpage

#### random effects

An alternative approach is to use random effects.

- If there are a large number of stations in the dataset and we are less interested in the stations themselves, we can use a random effect model. 

- Instead of directly estimating each we use a categorical variable in the modeling framework. In general there may be specific interest in those stations. 

$y_{it} \sim Poisson(\mu_{it})$

$log(\mu_{it}) = \alpha_i +  \gamma_1 +  \gamma_2+  \gamma_3+  \gamma_4 +  \gamma_5$

$\alpha_i \sim N(\alpha, \sigma^2_\alpha)$ and 

$\alpha_i = \alpha + u_i$, $u_i \sim N(0, \sigma^2_\alpha)$

- We can use `glmer` in `lme4` or `stan_glmer` in `rstanarm.` We will use the notation `(1|variable)` to denote a random effect on the variable.



\newpage

### GLMMs for Categorical Data

1. Logistic Regression

_Write out this model and simulate data from this setting_